<Page
    x:Class="optimizerDuck.UI.Views.Pages.Optimizations.OptimizationPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:optimizerDuck.Common.Helpers.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:ext="clr-namespace:optimizerDuck.Common.Extensions"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:optimizations="clr-namespace:optimizerDuck.UI.Views.Pages.Optimizations"
    xmlns:optimizers="clr-namespace:optimizerDuck.Core.Optimizers"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    Title="OptimizationPage"
    Margin="0,32,0,0"
    d:DataContext="{d:DesignInstance optimizations:OptimizationPage}"
    d:DesignHeight="650"
    d:DesignWidth="800"
    ui:Design.Background="Black"
    ui:Design.Foreground="White"
    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    ScrollViewer.CanContentScroll="False"
    mc:Ignorable="d">
    <Page.Resources>
        <converters:WidthToColumnConverter x:Key="WidthToColumnConverter" />
        <converters:ZeroToVisibilityConverter x:Key="ZeroToVisibilityConverter" />
        <converters:GreaterThanZeroToVisibilityConverter x:Key="GreaterThanZeroToVisibilityConverter" />
        <converters:NullToVisibilityConverter
            x:Key="NullToVisibilityConverter"
            False="Visible"
            True="Collapsed" />
    </Page.Resources>

    <Grid RowDefinitions="Auto,*">

        <!--  Toolbar  -->
        <WrapPanel
            Grid.Row="0"
            Margin="5,0,5,10"
            VerticalAlignment="Center"
            Orientation="Horizontal">

            <!--  Search  -->
            <ui:TextBox
                MinWidth="200"
                Margin="0,0,8,0"
                VerticalAlignment="Center"
                Icon="{ui:SymbolIcon Search24}"
                PlaceholderText="{ext:Loc Common.Search.Placeholder}"
                Text="{Binding ViewModel.SearchText, UpdateSourceTrigger=PropertyChanged}" />

            <!--  Filter by Risk  -->
            <ComboBox
                Margin="0,0,8,0"
                VerticalAlignment="Center"
                SelectedIndex="{Binding ViewModel.SelectedRiskFilterIndex}"
                ToolTip="{ext:Loc Common.Filter}">
                <ComboBoxItem HorizontalContentAlignment="Left">
                    <Grid HorizontalAlignment="Left" ColumnDefinitions="Auto Auto">
                        <ui:SymbolIcon
                            Margin="0,0,6,0"
                            HorizontalAlignment="Left"
                            Symbol="Filter24" />
                        <TextBlock
                            Grid.Column="1"
                            HorizontalAlignment="Left"
                            Text="{ext:Loc Common.Filter.All}" />
                    </Grid>
                </ComboBoxItem>
                <ComboBoxItem HorizontalContentAlignment="Left">
                    <Grid HorizontalAlignment="Left" ColumnDefinitions="Auto Auto">
                        <ui:SymbolIcon
                            Margin="0,0,6,0"
                            Foreground="{DynamicResource SystemFillColorSuccessBrush}"
                            Symbol="ShieldCheckmark24" />
                        <TextBlock Grid.Column="1" Text="{ext:Loc Optimizer.UI.Risk.Safe}" />
                    </Grid>
                </ComboBoxItem>
                <ComboBoxItem HorizontalContentAlignment="Left">
                    <Grid HorizontalAlignment="Left" ColumnDefinitions="Auto Auto">
                        <ui:SymbolIcon
                            Margin="0,0,6,0"
                            Foreground="{DynamicResource SystemFillColorCautionBrush}"
                            Symbol="Warning24" />
                        <TextBlock Grid.Column="1" Text="{ext:Loc Optimizer.UI.Risk.Moderate}" />
                    </Grid>
                </ComboBoxItem>
                <ComboBoxItem HorizontalContentAlignment="Left">
                    <Grid HorizontalAlignment="Left" ColumnDefinitions="Auto Auto">
                        <ui:SymbolIcon
                            Margin="0,0,6,0"
                            Foreground="{DynamicResource SystemFillColorCriticalBrush}"
                            Symbol="ShieldError24" />
                        <TextBlock Grid.Column="1" Text="{ext:Loc Optimizer.UI.Risk.Risky}" />
                    </Grid>
                </ComboBoxItem>
            </ComboBox>

            <!--  Sort By  -->
            <ComboBox
                Margin="0,0,8,0"
                VerticalAlignment="Center"
                SelectedIndex="{Binding ViewModel.SelectedSortByIndex}"
                ToolTip="{ext:Loc Common.SortBy}">
                <ComboBoxItem Content="{ext:Loc Common.SortBy.Default}" />
                <ComboBoxItem Content="{ext:Loc Common.SortBy.Name}" />
                <ComboBoxItem Content="{ext:Loc Common.SortBy.Risk}" />
            </ComboBox>

            <!--  Hide Applied toggle  -->
            <ToggleButton
                Margin="0,0,0,0"
                VerticalAlignment="Stretch"
                IsChecked="{Binding ViewModel.HideApplied}">
                <StackPanel Orientation="Horizontal">
                    <ui:SymbolIcon Margin="0,0,6,0" Symbol="EyeOff24" />
                    <TextBlock Text="{ext:Loc Optimizer.Menu.HideApplied}" />
                </StackPanel>
            </ToggleButton>
        </WrapPanel>

        <!--  No search results  -->
        <StackPanel
            Grid.Row="1"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Visibility="{Binding ViewModel.Optimizations.Count, Converter={StaticResource ZeroToVisibilityConverter}}">
            <ui:SymbolIcon
                Margin="0,0,0,10"
                HorizontalAlignment="Center"
                FontSize="36"
                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                Symbol="SearchInfo24" />
            <ui:TextBlock
                HorizontalAlignment="Center"
                Appearance="Secondary"
                FontTypography="Body"
                Text="{ext:Loc Bloatware.Search.NoResults}" />
        </StackPanel>

        <!--  Optimization Cards  -->
        <ui:VirtualizingItemsControl
            Grid.Row="1"
            ItemsSource="{Binding ViewModel.Optimizations}"
            Visibility="{Binding ViewModel.Optimizations.Count, Converter={StaticResource GreaterThanZeroToVisibilityConverter}}">
            <ui:VirtualizingItemsControl.Template>
                <ControlTemplate TargetType="ItemsControl">
                    <ScrollViewer HorizontalScrollBarVisibility="Disabled">
                        <ItemsPresenter />
                    </ScrollViewer>
                </ControlTemplate>
            </ui:VirtualizingItemsControl.Template>
            <ui:VirtualizingItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <UniformGrid VerticalAlignment="Top" Columns="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=ScrollViewer}, Converter={StaticResource WidthToColumnConverter}}" />
                </ItemsPanelTemplate>
            </ui:VirtualizingItemsControl.ItemsPanel>
            <ui:VirtualizingItemsControl.ItemContainerStyle>
                <Style TargetType="ContentPresenter">
                    <Setter Property="Margin" Value="5" />
                    <Setter Property="HorizontalAlignment" Value="Stretch" />
                </Style>
            </ui:VirtualizingItemsControl.ItemContainerStyle>

            <ui:VirtualizingItemsControl.ItemTemplate>
                <DataTemplate DataType="{x:Type optimizers:BaseOptimization}">
                    <Border
                        Padding="20,10"
                        Background="{DynamicResource CardBackground}"
                        BorderBrush="{DynamicResource CardBorderBrush}"
                        BorderThickness="1"
                        CornerRadius="5">
                        <Grid RowDefinitions="Auto,Auto,Auto,Auto,*">
                            <ui:TextBlock
                                Grid.Row="0"
                                Appearance="Disabled"
                                FontTypography="Caption"
                                Text="{Binding Id}"
                                TextWrapping="Wrap" />
                            <ui:TextBlock
                                Grid.Row="1"
                                FontTypography="Subtitle"
                                Text="{Binding Name}"
                                TextWrapping="Wrap" />

                            <ui:VirtualizingItemsControl
                                Grid.Row="2"
                                Margin="0,2,0,2"
                                ItemsSource="{Binding TagDisplays}">
                                <ui:VirtualizingItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel HorizontalAlignment="Left" VerticalAlignment="Top" />
                                    </ItemsPanelTemplate>
                                </ui:VirtualizingItemsControl.ItemsPanel>
                                <ui:VirtualizingItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <Setter Property="Margin" Value="0,0,2,2" />
                                        <Setter Property="HorizontalAlignment" Value="Left" />
                                    </Style>
                                </ui:VirtualizingItemsControl.ItemContainerStyle>
                                <ui:VirtualizingItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border
                                            Padding="4,2"
                                            HorizontalAlignment="Left"
                                            Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
                                            CornerRadius="5">
                                            <StackPanel Orientation="Horizontal">
                                                <ui:SymbolIcon
                                                    Margin="0,0,5,0"
                                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                    Symbol="{Binding Icon}" />

                                                <ui:TextBlock
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    Appearance="Secondary"
                                                    FontTypography="Caption"
                                                    Foreground="{DynamicResource TextFillColorInverseBrush}"
                                                    Text="{Binding Display}"
                                                    TextWrapping="Wrap" />
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ui:VirtualizingItemsControl.ItemTemplate>
                            </ui:VirtualizingItemsControl>

                            <ui:TextBlock
                                Grid.Row="3"
                                Margin="0,10,0,0"
                                FontTypography="Body"
                                Text="{Binding ShortDescription}"
                                TextTrimming="WordEllipsis"
                                TextWrapping="Wrap" />

                            <Grid
                                Grid.Row="4"
                                Margin="0,10,0,0"
                                VerticalAlignment="Bottom"
                                ColumnDefinitions="*,Auto">
                                <Grid RowDefinitions="Auto,Auto">
                                    <Border
                                        Padding="4,2"
                                        HorizontalAlignment="Left"
                                        CornerRadius="5">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Background" Value="{DynamicResource SystemFillColorSuccessBrush}" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Risk}" Value="Moderate">
                                                        <Setter Property="Background" Value="{DynamicResource SystemFillColorCautionBrush}" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Risk}" Value="Risky">
                                                        <Setter Property="Background" Value="{DynamicResource SystemFillColorCriticalBrush}" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <StackPanel Orientation="Horizontal">
                                            <ui:SymbolIcon
                                                Margin="0,0,5,0"
                                                Foreground="{DynamicResource TextFillColorInverseBrush}"
                                                Symbol="{Binding RiskVisual.Icon}" />

                                            <ui:TextBlock
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                FontTypography="Caption"
                                                Foreground="{DynamicResource TextFillColorInverseBrush}"
                                                Text="{Binding RiskVisual.Display}"
                                                TextWrapping="Wrap" />
                                        </StackPanel>
                                    </Border>

                                    <Border
                                        Grid.Row="1"
                                        Margin="0,5,0,0"
                                        Padding="4,2"
                                        HorizontalAlignment="Left"
                                        Background="{DynamicResource CardBackgroundDisabled}"
                                        CornerRadius="5"
                                        ToolTip="{Binding State.AppliedAt}"
                                        ToolTipService.InitialShowDelay="150"
                                        ToolTipService.Placement="Top"
                                        Visibility="{Binding State.AppliedAt, Converter={StaticResource NullToVisibilityConverter}}">
                                        <ui:TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontTypography="Caption"
                                            Text="{Binding State.RelativeTime}"
                                            TextWrapping="Wrap" />
                                    </Border>
                                </Grid>

                                <StackPanel
                                    Grid.Column="1"
                                    Margin="10,0,0,0"
                                    VerticalAlignment="Bottom"
                                    Orientation="Horizontal">
                                    <ui:ToggleSwitch
                                        Margin="0,0,5,0"
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Center"
                                        Command="{Binding DataContext.ViewModel.ToggleOptimizationCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                        CommandParameter="{Binding}"
                                        Cursor="Hand"
                                        IsChecked="{Binding State.IsApplied, Mode=TwoWay}" />
                                    <ui:Button
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Bottom"
                                        Background="Transparent"
                                        BorderBrush="Transparent"
                                        Command="{Binding DataContext.ViewModel.ViewSourceOnGitHubCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                        CommandParameter="{Binding}"
                                        Cursor="Hand"
                                        Icon="{ui:SymbolIcon Open24}"
                                        ToolTip="{ext:Loc Optimizer.Menu.ViewSource}" />
                                    <ui:Button
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Bottom"
                                        Background="Transparent"
                                        BorderBrush="Transparent"
                                        Command="{Binding DataContext.ViewModel.ShowDetailsCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                        CommandParameter="{Binding}"
                                        Cursor="Hand"
                                        Icon="{ui:SymbolIcon MoreVertical24}" />
                                </StackPanel>
                            </Grid>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ui:VirtualizingItemsControl.ItemTemplate>
        </ui:VirtualizingItemsControl>
    </Grid>
</Page>