<Page
    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    Margin="0,32,0,0"
    ScrollViewer.CanContentScroll="False"
    Title="OptimizationPage"
    d:DataContext="{d:DesignInstance optimizations:OptimizationPage}"
    d:DesignHeight="650"
    d:DesignWidth="800"
    mc:Ignorable="d"
    ui:Design.Background="Black"
    ui:Design.Foreground="White"
    x:Class="optimizerDuck.UI.Views.Pages.Optimizations.OptimizationPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:converters="clr-namespace:optimizerDuck.Common.Helpers.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:optimizations="clr-namespace:optimizerDuck.UI.Views.Pages.Optimizations"
    xmlns:optimizers="clr-namespace:optimizerDuck.Core.Optimizers"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    <Page.Resources>
        <converters:WidthToColumnConverter x:Key="WidthToColumnConverter" />
        <converters:NullToVisibilityConverter
            False="Visible"
            True="Collapsed"
            x:Key="NullToVisibilityConverter" />
    </Page.Resources>

    <Grid>
        <ui:VirtualizingItemsControl ItemsSource="{Binding ViewModel.Optimizations}">
            <ui:VirtualizingItemsControl.Template>
                <ControlTemplate TargetType="ItemsControl">
                    <ScrollViewer HorizontalScrollBarVisibility="Disabled">
                        <ItemsPresenter />
                    </ScrollViewer>
                </ControlTemplate>
            </ui:VirtualizingItemsControl.Template>
            <ui:VirtualizingItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <UniformGrid Columns="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=ScrollViewer}, Converter={StaticResource WidthToColumnConverter}}" VerticalAlignment="Top" />
                </ItemsPanelTemplate>
            </ui:VirtualizingItemsControl.ItemsPanel>
            <ui:VirtualizingItemsControl.ItemContainerStyle>
                <Style TargetType="ContentPresenter">
                    <Setter Property="Margin" Value="5" />
                    <Setter Property="HorizontalAlignment" Value="Stretch" />
                </Style>
            </ui:VirtualizingItemsControl.ItemContainerStyle>

            <ui:VirtualizingItemsControl.ItemTemplate>
                <DataTemplate DataType="{x:Type optimizers:BaseOptimization}">
                    <Border
                        Background="{DynamicResource CardBackground}"
                        BorderBrush="{DynamicResource CardBorderBrush}"
                        BorderThickness="1"
                        CornerRadius="5"
                        Padding="20,10">
                        <Grid RowDefinitions="Auto,Auto,Auto,Auto,*">
                            <ui:TextBlock
                                Appearance="Disabled"
                                FontTypography="Caption"
                                Grid.Row="0"
                                Text="{Binding Id}"
                                TextWrapping="Wrap" />
                            <ui:TextBlock
                                FontTypography="Subtitle"
                                Grid.Row="1"
                                Text="{Binding Name}"
                                TextWrapping="Wrap" />

                            <ui:VirtualizingItemsControl
                                Grid.Row="2"
                                ItemsSource="{Binding TagDisplays}"
                                Margin="0,2,0,2">
                                <ui:VirtualizingItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel HorizontalAlignment="Left" VerticalAlignment="Top" />
                                    </ItemsPanelTemplate>
                                </ui:VirtualizingItemsControl.ItemsPanel>
                                <ui:VirtualizingItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <Setter Property="Margin" Value="0,0,2,2" />
                                        <Setter Property="HorizontalAlignment" Value="Left" />
                                    </Style>
                                </ui:VirtualizingItemsControl.ItemContainerStyle>
                                <ui:VirtualizingItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border
                                            Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
                                            CornerRadius="5"
                                            HorizontalAlignment="Left"
                                            Padding="4,2">
                                            <StackPanel Orientation="Horizontal">
                                                <ui:SymbolIcon
                                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                    Margin="0,0,5,0"
                                                    Symbol="{Binding Icon}" />

                                                <ui:TextBlock
                                                    Appearance="Secondary"
                                                    FontTypography="Caption"
                                                    Foreground="{DynamicResource TextFillColorInverseBrush}"
                                                    HorizontalAlignment="Center"
                                                    Text="{Binding Display}"
                                                    TextWrapping="Wrap"
                                                    VerticalAlignment="Center" />
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ui:VirtualizingItemsControl.ItemTemplate>
                            </ui:VirtualizingItemsControl>

                            <ui:TextBlock
                                FontTypography="Body"
                                Grid.Row="3"
                                Margin="0,10,0,0"
                                Text="{Binding ShortDescription}"
                                TextTrimming="WordEllipsis"
                                TextWrapping="Wrap" />

                            <Grid
                                ColumnDefinitions="*,Auto"
                                Grid.Row="4"
                                Margin="0,10,0,0"
                                VerticalAlignment="Bottom">
                                <Grid RowDefinitions="Auto,Auto">
                                    <Border
                                        CornerRadius="5"
                                        HorizontalAlignment="Left"
                                        Padding="4,2">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Background" Value="{DynamicResource SystemFillColorSuccessBrush}" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Risk}" Value="Moderate">
                                                        <Setter Property="Background" Value="{DynamicResource SystemFillColorCautionBrush}" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Risk}" Value="Risky">
                                                        <Setter Property="Background" Value="{DynamicResource SystemFillColorCriticalBrush}" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <StackPanel Orientation="Horizontal">
                                            <ui:SymbolIcon
                                                Foreground="{DynamicResource TextFillColorInverseBrush}"
                                                Margin="0,0,5,0"
                                                Symbol="{Binding RiskVisual.Icon}" />

                                            <ui:TextBlock
                                                FontTypography="Caption"
                                                Foreground="{DynamicResource TextFillColorInverseBrush}"
                                                HorizontalAlignment="Center"
                                                Text="{Binding RiskVisual.Display}"
                                                TextWrapping="Wrap"
                                                VerticalAlignment="Center" />
                                        </StackPanel>
                                    </Border>

                                    <Border
                                        Background="{DynamicResource CardBackgroundDisabled}"
                                        CornerRadius="5"
                                        Grid.Row="1"
                                        HorizontalAlignment="Left"
                                        Margin="0,5,0,0"
                                        Padding="4,2"
                                        ToolTip="{Binding State.AppliedAt}"
                                        ToolTipService.InitialShowDelay="150"
                                        ToolTipService.Placement="Top"
                                        Visibility="{Binding State.AppliedAt, Converter={StaticResource NullToVisibilityConverter}}">
                                        <ui:TextBlock
                                            FontTypography="Caption"
                                            HorizontalAlignment="Center"
                                            Text="{Binding State.RelativeTime}"
                                            TextWrapping="Wrap"
                                            VerticalAlignment="Center" />
                                    </Border>
                                </Grid>

                                <Grid
                                    ColumnDefinitions="*,Auto"
                                    Grid.Column="1"
                                    Margin="10,0,0,0"
                                    VerticalAlignment="Bottom">
                                    <ui:ToggleSwitch
                                        Command="{Binding DataContext.ViewModel.ToggleOptimizationCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                        CommandParameter="{Binding}"
                                        Cursor="Hand"
                                        HorizontalAlignment="Right"
                                        IsChecked="{Binding State.IsApplied, Mode=TwoWay}"
                                        Margin="0,0,5,0"
                                        VerticalAlignment="Center" />
                                    <ui:Button
                                        Background="Transparent"
                                        BorderBrush="Transparent"
                                        Command="{Binding DataContext.ViewModel.ShowDetailsCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                        CommandParameter="{Binding}"
                                        Cursor="Hand"
                                        Grid.Column="1"
                                        HorizontalAlignment="Right"
                                        Icon="{ui:SymbolIcon MoreVertical24}"
                                        VerticalAlignment="Bottom" />
                                </Grid>
                            </Grid>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ui:VirtualizingItemsControl.ItemTemplate>
        </ui:VirtualizingItemsControl>
    </Grid>
</Page>