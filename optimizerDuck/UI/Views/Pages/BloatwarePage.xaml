<Page
    x:Class="optimizerDuck.UI.Views.Pages.BloatwarePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:bloatware="clr-namespace:optimizerDuck.Core.Models.Bloatware"
    xmlns:converters="clr-namespace:optimizerDuck.Common.Helpers.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:ext="clr-namespace:optimizerDuck.Common.Extensions"
    xmlns:local="clr-namespace:optimizerDuck.UI.Views.Pages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    Title="BloatwarePage"
    Margin="0,32,0,0"
    d:DataContext="{d:DesignInstance local:BloatwarePage}"
    d:DesignHeight="1200"
    d:DesignWidth="800"
    ui:Design.Background="Black"
    ui:Design.Foreground="White"
    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    ScrollViewer.CanContentScroll="False"
    mc:Ignorable="d">
    <Page.Resources>
        <converters:GreaterThanZeroToVisibilityConverter x:Key="GreaterThanZeroToVisibilityConverter" />
        <converters:ZeroToVisibilityConverter x:Key="ZeroToVisibilityConverter" />
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:EmptyWhileNotLoadingConverter x:Key="EmptyWhileNotLoadingConverter" />
    </Page.Resources>

    <Grid RowDefinitions="Auto *">
        <ui:TextBlock
            Margin="0,0,0,20"
            FontTypography="Title"
            Text="{ext:Loc Bloatware.Header.Title}"
            TextWrapping="Wrap" />

        <!--  Empty (truly no packages installed)  -->
        <Border Grid.Row="1">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Visibility" Value="Collapsed" />
                    <Style.Triggers>
                        <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding ViewModel.HasData}" Value="False" />
                                <Condition Binding="{Binding ViewModel.IsLoading}" Value="False" />
                            </MultiDataTrigger.Conditions>
                            <Setter Property="Visibility" Value="Visible" />
                        </MultiDataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ui:SymbolIcon
                    Margin="0,0,0,15"
                    HorizontalAlignment="Center"
                    FontSize="46"
                    Foreground="{DynamicResource SystemFillColorCriticalBrush}"
                    Symbol="DeleteOff24" />
                <ui:TextBlock
                    HorizontalAlignment="Center"
                    FontTypography="Subtitle"
                    Text="{ext:Loc Bloatware.Empty.Title}" />
                <ui:TextBlock
                    Margin="0,0,0,10"
                    HorizontalAlignment="Center"
                    Appearance="Secondary"
                    FontTypography="Body"
                    Text="{ext:Loc Bloatware.Empty.Description}" />
                <ui:Button
                    HorizontalAlignment="Center"
                    Appearance="Primary"
                    Command="{Binding ViewModel.RefreshCommand}"
                    Content="{ext:Loc Bloatware.Menu.Refresh}"
                    Icon="{ui:SymbolIcon ArrowClockwise24,
                                         FontSize=18}" />
            </StackPanel>
        </Border>

        <!--  Loading  -->
        <Border Grid.Row="1" Visibility="{Binding ViewModel.IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ui:ProgressRing
                    Margin="0,0,0,5"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    IsIndeterminate="True" />
                <ui:TextBlock
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    FontTypography="BodyStrong"
                    Text="{ext:Loc Bloatware.Loading}" />
            </StackPanel>
        </Border>

        <Border
            Grid.Row="1"
            Padding="8"
            Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
            CornerRadius="6"
            Visibility="{Binding ViewModel.HasData, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid RowDefinitions="Auto,Auto,*">

                <!--  Search / Filter / Sort toolbar  -->
                <WrapPanel
                    Grid.Row="0"
                    Margin="0,0,0,5"
                    Orientation="Horizontal">

                    <!--  Search  -->
                    <ui:TextBox
                        MinWidth="200"
                        Margin="0,0,8,4"
                        Icon="{ui:SymbolIcon Search24}"
                        PlaceholderText="{ext:Loc Common.Search.Placeholder}"
                        Text="{Binding ViewModel.SearchText, UpdateSourceTrigger=PropertyChanged}" />

                    <!--  Filter by Risk  -->
                    <ComboBox
                        Margin="0,0,8,0"
                        VerticalAlignment="Center"
                        SelectedIndex="{Binding ViewModel.SelectedRiskFilterIndex}"
                        ToolTip="{ext:Loc Common.Filter}">
                        <ComboBoxItem HorizontalContentAlignment="Left">
                            <Grid HorizontalAlignment="Left" ColumnDefinitions="Auto Auto">
                                <ui:SymbolIcon
                                    Margin="0,0,6,0"
                                    HorizontalAlignment="Left"
                                    Symbol="Filter24" />
                                <TextBlock
                                    Grid.Column="1"
                                    HorizontalAlignment="Left"
                                    Text="{ext:Loc Common.Filter.All}" />
                            </Grid>
                        </ComboBoxItem>
                        <ComboBoxItem HorizontalContentAlignment="Left">
                            <Grid HorizontalAlignment="Left" ColumnDefinitions="Auto Auto">
                                <ui:SymbolIcon
                                    Margin="0,0,6,0"
                                    HorizontalAlignment="Left"
                                    Foreground="{DynamicResource SystemFillColorSuccessBrush}"
                                    Symbol="ShieldCheckmark24" />
                                <TextBlock Grid.Column="1" Text="{ext:Loc Optimizer.UI.Risk.Safe}" />
                            </Grid>
                        </ComboBoxItem>
                        <ComboBoxItem HorizontalContentAlignment="Left">
                            <Grid HorizontalAlignment="Left" ColumnDefinitions="Auto Auto">
                                <ui:SymbolIcon
                                    Margin="0,0,6,0"
                                    HorizontalAlignment="Left"
                                    Foreground="{DynamicResource SystemFillColorCautionBrush}"
                                    Symbol="Warning24" />
                                <TextBlock Grid.Column="1" Text="{ext:Loc Optimizer.UI.Risk.Moderate}" />
                            </Grid>
                        </ComboBoxItem>
                    </ComboBox>
                    <!--  Sort By  -->
                    <ComboBox
                        Margin="0,0,8,4"
                        SelectedIndex="{Binding ViewModel.SelectedSortByIndex}"
                        ToolTip="{ext:Loc Common.SortBy}">
                        <ComboBoxItem Content="{ext:Loc Common.SortBy.Default}" />
                        <ComboBoxItem Content="{ext:Loc Common.SortBy.Name}" />
                        <ComboBoxItem Content="{ext:Loc Common.SortBy.Publisher}" />
                        <ComboBoxItem Content="{ext:Loc Common.SortBy.Risk}" />
                    </ComboBox>
                </WrapPanel>

                <!--  Action buttons  -->
                <StackPanel
                    Grid.Row="1"
                    Margin="0,0,0,5"
                    Orientation="Horizontal">
                    <ui:Button
                        Appearance="Danger"
                        Command="{Binding ViewModel.RemoveSelectedCommand}"
                        Content="{ext:Loc Bloatware.Menu.Remove,
                                          {Binding ViewModel.SelectedCount}}"
                        Icon="{ui:SymbolIcon Delete24,
                                             FontSize=18}" />

                    <Separator Margin="3,0,3,0" />

                    <ui:Button
                        Appearance="Success"
                        Command="{Binding ViewModel.SelectAllSafeCommand}"
                        Content="{ext:Loc Bloatware.Menu.SelectAllSafe}"
                        Icon="{ui:SymbolIcon ShieldCheckmark24,
                                             FontSize=18}" />

                    <Separator Margin="3,0,3,0" />

                    <ui:Button
                        Appearance="Primary"
                        Command="{Binding ViewModel.RefreshCommand}"
                        Content="{ext:Loc Bloatware.Menu.Refresh}"
                        Icon="{ui:SymbolIcon ArrowClockwise24,
                                             FontSize=18}" />
                </StackPanel>

                <!--  No search results  -->
                <StackPanel
                    Grid.Row="2"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Visibility="{Binding ViewModel.AppxPackages.Count, Converter={StaticResource ZeroToVisibilityConverter}}">
                    <ui:SymbolIcon
                        Margin="0,0,0,10"
                        HorizontalAlignment="Center"
                        FontSize="36"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Symbol="SearchInfo24" />
                    <ui:TextBlock
                        HorizontalAlignment="Center"
                        Appearance="Secondary"
                        FontTypography="Body"
                        Text="{ext:Loc Bloatware.Search.NoResults}" />
                </StackPanel>

                <ui:VirtualizingItemsControl
                    Grid.Row="2"
                    ItemsSource="{Binding ViewModel.AppxPackages}"
                    Visibility="{Binding ViewModel.AppxPackages.Count, Converter={StaticResource GreaterThanZeroToVisibilityConverter}}">
                    <ui:VirtualizingItemsControl.Template>
                        <ControlTemplate TargetType="ItemsControl">
                            <ScrollViewer HorizontalScrollBarVisibility="Disabled">
                                <ItemsPresenter />
                            </ScrollViewer>
                        </ControlTemplate>
                    </ui:VirtualizingItemsControl.Template>
                    <!--  Layout panel  -->
                    <ui:VirtualizingItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel />
                        </ItemsPanelTemplate>
                    </ui:VirtualizingItemsControl.ItemsPanel>

                    <!--  Item template  -->
                    <ui:VirtualizingItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type bloatware:AppXPackage}">
                            <Border
                                Margin="0,0,0,4"
                                Padding="12"
                                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                CornerRadius="6">

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!--  Checkbox  -->
                                    <CheckBox
                                        Grid.Column="0"
                                        Margin="0,4,12,0"
                                        VerticalAlignment="Top"
                                        IsChecked="{Binding IsSelected, Mode=TwoWay}" />

                                    <!--  Content  -->
                                    <StackPanel Grid.Column="1">

                                        <!--  Top row  -->
                                        <DockPanel LastChildFill="False">

                                            <!--  App Name  -->
                                            <ui:TextBlock FontTypography="BodyStrong" Text="{Binding Name}" />

                                            <Border
                                                Margin="5,0,0,0"
                                                Padding="4,1"
                                                HorizontalAlignment="Left"
                                                VerticalAlignment="Center"
                                                Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
                                                CornerRadius="5">
                                                <!--  Version  -->
                                                <ui:TextBlock
                                                    VerticalAlignment="Center"
                                                    Appearance="Tertiary"
                                                    FontTypography="Body"
                                                    Text="{Binding Version}" />
                                            </Border>

                                            <Border
                                                Margin="5,0,0,0"
                                                Padding="4,2"
                                                HorizontalAlignment="Left"
                                                CornerRadius="5"
                                                Visibility="{Binding ShouldVisibleRisk, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="Background" Value="{DynamicResource SystemFillColorSuccessBrush}" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Risk}" Value="Caution">
                                                                <Setter Property="Background" Value="{DynamicResource SystemFillColorCautionBrush}" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <StackPanel Orientation="Horizontal">
                                                    <ui:SymbolIcon
                                                        Margin="0,0,5,0"
                                                        Foreground="{DynamicResource TextFillColorInverseBrush}"
                                                        Symbol="{Binding RiskVisual.Icon}" />

                                                    <ui:TextBlock
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"
                                                        FontTypography="Caption"
                                                        Foreground="{DynamicResource TextFillColorInverseBrush}"
                                                        Text="{Binding RiskVisual.Display}"
                                                        TextWrapping="Wrap" />
                                                </StackPanel>
                                            </Border>
                                        </DockPanel>

                                        <!--  Publisher  -->
                                        <ui:TextBlock
                                            Margin="0,2,0,0"
                                            Appearance="Disabled"
                                            FontTypography="Body"
                                            Text="{Binding Publisher}"
                                            TextTrimming="CharacterEllipsis" />

                                        <!--  Install location  -->
                                        <ui:TextBlock
                                            Margin="0,2,0,0"
                                            Appearance="Disabled"
                                            FontTypography="Body"
                                            Text="{Binding InstallLocation}"
                                            TextTrimming="CharacterEllipsis" />

                                        <!--  Package full name  -->
                                        <ui:TextBlock
                                            Margin="0,4,0,0"
                                            Appearance="Secondary"
                                            FontTypography="Caption"
                                            Text="{Binding PackageFullName}"
                                            TextTrimming="CharacterEllipsis" />
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ui:VirtualizingItemsControl.ItemTemplate>
                </ui:VirtualizingItemsControl>
            </Grid>
        </Border>
    </Grid>
</Page>